<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>POS Maretti — Full (Simple UI)</title>
<style>
  /* Simple, clear UI (not premium) */
  :root{--bg:#ffffff;--card:#f7f7f8;--muted:#6b7280;--accent:#0ea5a4;--danger:#ff5252}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#0b1220}
  .wrap{max-width:1100px;margin:14px auto;padding:12px}
  header{display:flex;align-items:center;gap:12px}
  .title{background:var(--card);padding:10px 14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
  .muted{color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:12px;margin-top:12px}
  .card{background:#fff;border:1px solid #e6e7ea;padding:12px;border-radius:8px}
  .panel{max-height:68vh;overflow:auto;padding:6px}
  input,select,textarea,button{font-size:14px}
  input,select,textarea{padding:8px;border:1px solid #e6e7ea;border-radius:6px;width:100%}
  button{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .ghost{background:transparent;color:#0b1220;border:1px solid #e6e7ea}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #f0f0f0;text-align:left}
  .small{font-size:13px;color:var(--muted)}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#eef7f6;color:#064145;font-weight:600}
  .hidden{display:none}
  .toolbar{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  @media(max-width:900px){.layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="flex:1">
      <div class="title"><strong>POS Maretti — Full</strong></div>
      <div class="muted small">Prosty UI, wszystkie funkcje POS. Hostuj jako <code>index.html</code> na GitHub Pages.</div>
    </div>
    <div>
      <button id="btnSettings" class="ghost">Ustawienia</button>
    </div>
  </header>

  <div class="layout">
    <main class="card">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="badge">Użytkownik: <strong id="userLabel">Maretti Admin</strong></div>
        <div class="small" style="margin-left:12px">Kasa: <span id="tillState">Zamknięta</span></div>
        <div class="right toolbar">
          <button id="openTill" class="ghost">Otwórz kasę</button>
          <button id="closeTill" class="ghost hidden">Zamknij kasę</button>
          <button id="newOrder" class="ghost">Nowe zamówienie</button>
        </div>
      </div>

      <section style="margin-top:12px" class="panel">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="search" placeholder="Szukaj produktu lub SKU" />
          <select id="filterCat"></select>
          <button id="addManual" class="ghost">Dodaj ręcznie</button>
        </div>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <div id="products" class="card panel" aria-live="polite"></div>
          </div>

          <aside style="width:360px">
            <div class="card">
              <h3 style="margin-top:0">Koszyk</h3>
              <table><thead><tr><th>Produkt</th><th>Ilość</th><th>Razem</th></tr></thead><tbody id="cart"></tbody></table>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <div class="small">Rabat</div>
                <input id="discount" placeholder="np. 10% lub 5zł" style="width:140px"/>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <div class="small">Punkty klienta</div>
                <div id="clientPoints" class="small">0</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
                <select id="payments"></select>
                <button id="pay">Zapłać</button>
              </div>
              <div style="margin-top:8px" class="small">Suma: <strong id="sum">0.00 zł</strong></div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="returnOrder" class="ghost">Zwrót</button>
                <button id="receipt" class="ghost">Paragon (PDF)</button>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <section style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <button id="exportBtn" class="ghost">Eksportuj JSON</button>
          <button id="importBtn" class="ghost">Importuj JSON</button>
          <input id="fileImport" type="file" accept="application/json" class="hidden"/>
          <button id="clearBtn" class="ghost" style="background:var(--danger);color:#fff">Usuń dane</button>
        </div>
      </section>
    </main>

    <aside>
      <div class="card">
        <h3>Administracja</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <button id="manageProd" class="ghost">Produkty</button>
          <button id="manageStock" class="ghost">Magazyn</button>
          <button id="manageClients" class="ghost">Klienci</button>
          <button id="manageSup" class="ghost">Dostawcy</button>
          <button id="managePromo" class="ghost">Promocje</button>
          <button id="managePay" class="ghost">Metody płatności</button>
        </div>

        <hr style="margin:10px 0"/>

        <div>
          <strong>Program lojalnościowy</strong>
          <div class="small muted">Domyślnie: <code>20 zł = 100 pkt</code> • <code>100 pkt = 2.50 zł</code></div>
          <div style="display:flex;gap:6px;margin-top:6px">
            <input id="cfg_zl_per_100" placeholder="zł za 100 pkt" style="width:120px" />
            <input id="cfg_100pt_to_zl" placeholder="100 pkt -> zł" style="width:120px" />
          </div>
          <div style="margin-top:6px"><button id="saveLoyal" class="ghost">Zapisz</button></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Info</h4>
        <div class="small">Login auto: <strong>Maretti Admin</strong></div>
        <div class="small">Hasło: <strong>1312</strong></div>
        <div class="small" style="margin-top:6px">PWA: dodaj na ekran główny w Safari żeby działało offline.</div>
      </div>
    </aside>
  </div>
</div>

<!-- Login modal (removed from DOM on success to avoid touch-block) -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#fff;padding:18px;border-radius:10px;max-width:420px;width:90%">
    <h2 style="margin-top:0">Zaloguj się</h2>
    <div class="small">Użytkownik: <strong>Maretti Admin</strong></div>
    <div style="margin-top:8px">
      <input id="pwd" type="password" placeholder="Hasło" style="width:100%;padding:10px;border-radius:6px;border:1px solid #e6e7ea"/>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button id="loginBtn" class="ghost">Zaloguj</button>
      <button id="loginClose" class="ghost">Anuluj</button>
    </div>
    <div id="loginMsg" class="small" style="margin-top:8px;color:#b91c1c"></div>
  </div>
</div>

<!-- Editor modal -->
<div id="editor" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9000">
  <div style="background:#fff;padding:12px;border-radius:8px;width:92%;max-width:900px;max-height:86vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="editorTitle">Edytuj</h3>
      <div><button id="closeEditor" class="ghost">Zamknij</button></div>
    </div>
    <div id="editorBody" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* Single-file POS logic (simple UI). All data in localStorage. */
const STORAGE='pos_maretti_v3';
let DB = {
  products: [],
  clients: [],
  suppliers: [],
  promos: [],
  payments: [{id:'cash',name:'Gotówka'},{id:'card',name:'Karta'}],
  orders: [],
  till: {open:false,cash:0}
};
let loyalty = {zlPer100:20, zlFor100pt:2.5}; // zlPer100 means how many zł gives 100 pts
let CART = {items:[],discount:0,clientId:null};

function save(){
  localStorage.setItem(STORAGE, JSON.stringify({DB,loyalty}));
}
function load(){
  const raw = localStorage.getItem(STORAGE);
  if(raw) try{ const obj = JSON.parse(raw); DB = obj.DB || DB; loyalty = obj.loyalty || loyalty;}catch(e){console.error(e);}
}
load();

// seed if empty
if(DB.products.length===0){
  DB.products.push({id:'p1',sku:'ESP',name:'Espresso',price:6,stock:50,unit:'szt',category:'Napoje'});
  DB.products.push({id:'p2',sku:'LAT',name:'Latte',price:12,stock:30,unit:'szt',category:'Napoje'});
  save();
}

// helpers
const $ = id => document.getElementById(id);
function createElem(tag,cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }

// UI rendering
function refreshCategories(){
  const sel = $('filterCat');
  sel.innerHTML = '';
  const cats = ['Wszystkie', ...new Set(DB.products.map(p=>p.category).filter(Boolean))];
  cats.forEach(c=>{ const opt = document.createElement('option'); opt.value=c; opt.textContent=c; sel.appendChild(opt); });
}

function renderProducts(q=''){
  const node = $('products'); node.innerHTML='';
  const query = (q||'').toString().toLowerCase();
  DB.products.forEach(p=>{
    if(query){
      if(!(p.name.toLowerCase().includes(query) || (p.sku||'').toLowerCase().includes(query))) return;
    }
    const row = createElem('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px'; row.style.borderBottom='1px solid #f3f4f6';
    const left = createElem('div');
    left.innerHTML = '<strong>'+escapeHtml(p.name)+'</strong><div class="small">'+'SKU:'+escapeHtml(p.sku||'-')+' • '+(p.category||'-')+' • '+(p.stock||0)+' '+(p.unit||'')+'</div>';
    const right = createElem('div'); right.style.display='flex'; right.style.gap='6px'; right.style.alignItems='center';
    const qty = createElem('input'); qty.type='number'; qty.value='1'; qty.style.width='70px'; qty.min='0.01';
    const add = createElem('button','ghost'); add.textContent='Dodaj';
    add.addEventListener('click', ()=>{ addToCart(p.id, parseFloat(qty.value)||1); });
    right.appendChild(qty); right.appendChild(add);
    row.appendChild(left); row.appendChild(right);
    node.appendChild(row);
  });
}

function addToCart(productId, qty){
  const p = DB.products.find(x=>x.id===productId);
  if(!p) { alert('Brak produktu'); return; }
  CART.items.push({productId:p.id,name:p.name,price:p.price,qty:qty,unit:p.unit});
  renderCart();
}

function renderCart(){
  const tbody = $('cart'); tbody.innerHTML='';
  let total = 0;
  CART.items.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    const line = (it.price * it.qty);
    total += line;
    tr.innerHTML = '<td>'+escapeHtml(it.name)+'</td><td><input data-idx="'+idx+'" class="qty" style="width:60px" value="'+it.qty+'"></td><td>'+line.toFixed(2)+' zł <button data-idx="'+idx+'" class="ghost">x</button></td>';
    tbody.appendChild(tr);
  });
  // attach events
  tbody.querySelectorAll('input.qty').forEach(input=>{
    input.addEventListener('change', (e)=>{ const idx = parseInt(e.target.getAttribute('data-idx')); CART.items[idx].qty = parseFloat(e.target.value) || 0; renderCart(); });
  });
  tbody.querySelectorAll('button.ghost').forEach(btn=>{
    btn.addEventListener('click', (e)=>{ const idx = parseInt(e.target.getAttribute('data-idx')); CART.items.splice(idx,1); renderCart(); });
  });

  // discount parsing
  const dval = ($('discount').value||'').toString().trim();
  let disc = 0;
  if(dval){
    if(dval.endsWith('%')) disc = total * (parseFloat(dval)/100);
    else if(dval.endsWith('z') || dval.endsWith('zł')) disc = parseFloat(dval) || 0;
    else if(dval.includes('%')) disc = total * (parseFloat(dval)/100);
    else disc = parseFloat(dval) || 0;
  }
  const final = Math.max(0, total - disc);
  $('sum').textContent = final.toFixed(2) + ' zł';
}

function populatePayments(){
  const sel = $('payments'); sel.innerHTML='';
  DB.payments.forEach(p=>{ const opt = document.createElement('option'); opt.value=p.id; opt.textContent=p.name; sel.appendChild(opt); });
}

// Payment / finalize sale
$('pay').addEventListener('click', ()=>{
  if(!DB.till.open){ alert('Otwórz kasę przed sprzedażą'); return; }
  if(CART.items.length===0){ alert('Koszyk jest pusty'); return; }
  // reduce stock
  let total = 0;
  CART.items.forEach(it=>{
    const prod = DB.products.find(p=>p.id===it.productId);
    if(prod) prod.stock = (parseFloat(prod.stock)||0) - parseFloat(it.qty);
    total += it.price * it.qty;
  });
  // loyalty points gain
  const pts = Math.floor(total / loyalty.zlPer100 * 100);
  const order = {id:'o'+Date.now(), items: JSON.parse(JSON.stringify(CART.items)), total: total, discount: $('discount').value||'', paidWith: $('payments').value, ptsGained: pts, date: new Date().toISOString()};
  DB.orders.push(order);
  save();
  alert('Sprzedano. Punkty zdobyte: '+pts);
  CART = {items:[],discount:0,clientId:null};
  renderCart(); renderProducts($('search').value); populatePayments();
});

// returns
$('returnOrder').addEventListener('click', ()=>{
  const id = prompt('Podaj ID zamówienia do zwrotu (np. o123456789)');
  if(!id) return;
  const o = DB.orders.find(x=>x.id===id);
  if(!o){ alert('Nie znaleziono zamówienia'); return; }
  // restock
  o.items.forEach(it=>{
    const p = DB.products.find(x=>x.id===it.productId);
    if(p) p.stock = (parseFloat(p.stock)||0) + parseFloat(it.qty);
  });
  save();
  alert('Zwrócono zamówienie '+id);
  renderProducts($('search').value);
});

// Export / Import
$('exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({DB,loyalty},null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'pos_maretti_export.json'; a.click();
});
$('importBtn').addEventListener('click', ()=>$('fileImport').click());
$('fileImport').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{ const o = JSON.parse(r.result); if(o.DB) DB = o.DB; if(o.loyalty) loyalty = o.loyalty; save(); alert('Zaimportowano'); location.reload(); }catch(err){ alert('Błąd importu'); } };
  r.readAsText(f);
});

// clear
$('clearBtn').addEventListener('click', ()=>{ if(confirm('Usunąć wszystkie dane lokalne?')){ localStorage.removeItem(STORAGE); location.reload(); } });

// Management panels (editor)
function openEditor(title,htmlGenerator){
  $('editorTitle').textContent = title;
  $('editorBody').innerHTML = '';
  $('editor').classList.remove('hidden');
  htmlGenerator();
}
$('closeEditor').addEventListener('click', ()=> $('editor').classList.add('hidden'));

// Products manager
$('manageProd').addEventListener('click', ()=> openEditor('Produkty', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<div style="display:flex;gap:12px"><div style="flex:1"><h4>Lista</h4><div id="prodList"></div></div><div style="width:360px"><h4>Dodaj/Edytuj</h4><div id="prodForm"></div></div></div>';
  const list = $('prodList'), form = $('prodForm');
  function redraw(){
    list.innerHTML=''; DB.products.forEach(p=>{
      const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #f3f4f6';
      el.innerHTML = '<strong>'+escapeHtml(p.name)+'</strong><div class="small">SKU:'+escapeHtml(p.sku||'-')+' • '+(p.category||'-')+' • '+(p.stock||0)+' '+(p.unit||'')+'</div><div style="margin-top:6px"><button data-id="'+p.id+'" class="ghost">Edytuj</button> <button data-del="'+p.id+'" class="ghost">Usuń</button></div>';
      list.appendChild(el);
    });
    list.querySelectorAll('[data-id]').forEach(b=> b.addEventListener('click', (e)=>{
      const id = e.target.getAttribute('data-id'); const p = DB.products.find(x=>x.id===id); fillForm(p);
    }));
    list.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', (e)=>{
      if(confirm('Usuń produkt?')){ DB.products = DB.products.filter(x=>x.id!==e.target.getAttribute('data-del')); redraw(); save(); refreshCategories(); renderProducts($('search').value); }
    }));
  }
  function fillForm(p){
    form.innerHTML = '<div><label>Nazwa</label><input id="pf_name" value="'+escapeHtml(p.name)+'"/></div><div><label>SKU</label><input id="pf_sku" value="'+escapeHtml(p.sku||'')+'"/></div><div><label>Cena</label><input id="pf_price" value="'+(p.price||0)+'"/></div><div><label>Stan</label><input id="pf_stock" value="'+(p.stock||0)+'"/></div><div><label>Jednostka</label><input id="pf_unit" value="'+escapeHtml(p.unit||'szt')+'"/></div><div><label>Kategoria</label><input id="pf_cat" value="'+escapeHtml(p.category||'')+'"/></div><div style="margin-top:8px"><button id="saveProd" class="ghost">Zapisz</button></div>';
    $('saveProd').addEventListener('click', ()=>{
      p.name = $('pf_name').value; p.sku = $('pf_sku').value; p.price = parseFloat($('pf_price').value)||0; p.stock = parseFloat($('pf_stock').value)||0; p.unit = $('pf_unit').value; p.category = $('pf_cat').value;
      save(); redraw(); refreshCategories(); renderProducts($('search').value);
    });
  }
  form.innerHTML = '<div><label>Nazwa</label><input id="new_name"/></div><div><label>SKU</label><input id="new_sku"/></div><div><label>Cena</label><input id="new_price" value="0"/></div><div><label>Stan</label><input id="new_stock" value="0"/></div><div><label>Jednostka</label><input id="new_unit" value="szt"/></div><div><label>Kategoria</label><input id="new_cat"/></div><div style="margin-top:8px"><button id="addProd" class="ghost">Dodaj produkt</button></div>';
  $('addProd').addEventListener('click', ()=>{ const p={id:'p'+Date.now(), sku:$('new_sku').value, name:$('new_name').value, price:parseFloat($('new_price').value)||0, stock:parseFloat($('new_stock').value)||0, unit:$('new_unit').value, category:$('new_cat').value}; DB.products.push(p); save(); redraw(); refreshCategories(); renderProducts($('search').value); });
  redraw();
}));

// Stock manager (deliveries, corrections)
$('manageStock').addEventListener('click', ()=> openEditor('Magazyn', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<h4>Magazyn</h4><div id="stockList"></div><div style="margin-top:8px"><label>Dostawa (SKU/ilosc)</label><input id="d_inp" placeholder="SKU/10"/><button id="applyD" class="ghost">Zastosuj</button></div>';
  function redraw(){ const list = $('stockList'); list.innerHTML=''; DB.products.forEach(p=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f3f4f6'; d.innerHTML = '<strong>'+escapeHtml(p.name)+'</strong><div class="small">'+(p.stock||0)+' '+(p.unit||'')+' • SKU:'+escapeHtml(p.sku||'')+'</div><div style="margin-top:6px"><button data-id="'+p.id+'" class="ghost">Korekta</button></div>'; list.appendChild(d); }); list.querySelectorAll('[data-id]').forEach(b=> b.addEventListener('click', (e)=>{ const id=e.target.getAttribute('data-id'); const p = DB.products.find(x=>x.id===id); const v = prompt('Nowy stan dla '+p.name, p.stock); if(v!==null){ p.stock = parseFloat(v)||0; save(); redraw(); renderProducts($('search').value); } })); }
  $('applyD').addEventListener('click', ()=>{ const v = $('d_inp').value.trim(); const parts = v.split('/'); if(parts.length<2){ alert('Użyj formatu SKU/ilość'); return; } const sku = parts[0].trim(); const qty = parseFloat(parts[1])||0; const p = DB.products.find(x=>x.sku===sku); if(!p){ alert('Brak SKU'); return; } p.stock += qty; save(); redraw(); renderProducts($('search').value); });
  redraw();
}));

// Clients manager (CRM + loyalty points)
$('manageClients').addEventListener('click', ()=> openEditor('Klienci', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<div id="clientsList"></div><div style="margin-top:8px"><h4>Dodaj klienta</h4><input id="c_name" placeholder="Nazwa"/><input id="c_phone" placeholder="Telefon"/><button id="addClient" class="ghost">Dodaj</button></div>';
  function redraw(){ const list = $('clientsList'); list.innerHTML=''; DB.clients.forEach(c=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f3f4f6'; d.innerHTML = '<strong>'+escapeHtml(c.name)+'</strong><div class="small">tel: '+escapeHtml(c.phone||'-')+' • pkt: '+(c.points||0)+'</div>'; list.appendChild(d); }); }
  $('addClient').addEventListener('click', ()=>{ DB.clients.push({id:'c'+Date.now(), name:$('c_name').value, phone:$('c_phone').value, points:0}); save(); redraw(); });
  redraw();
}));

// Suppliers
$('manageSup').addEventListener('click', ()=> openEditor('Dostawcy', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<div id="supList"></div><div style="margin-top:8px"><input id="sup_name" placeholder="Nazwa"/><input id="sup_tel" placeholder="Tel"/><button id="addSup" class="ghost">Dodaj</button></div>';
  function redraw(){ const list = $('supList'); list.innerHTML=''; DB.suppliers.forEach(s=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f3f4f6'; d.innerHTML = '<strong>'+escapeHtml(s.name)+'</strong><div class="small">'+escapeHtml(s.phone||'-')+'</div>'; list.appendChild(d); }); }
  $('addSup').addEventListener('click', ()=>{ DB.suppliers.push({id:'s'+Date.now(), name:$('sup_name').value, phone:$('sup_tel').value}); save(); redraw(); });
  redraw();
}));

// Promotions
$('managePromo').addEventListener('click', ()=> openEditor('Promocje', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<div id="promoList"></div><div style="margin-top:8px"><input id="promo_name" placeholder="Nazwa"/><input id="promo_type" placeholder="np. %"/><input id="promo_val" placeholder="Wartość"/><button id="addPromo" class="ghost">Dodaj</button></div>';
  function redraw(){ const list = $('promoList'); list.innerHTML=''; DB.promos.forEach(p=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f3f4f6'; d.innerHTML = '<strong>'+escapeHtml(p.name)+'</strong><div class="small">'+escapeHtml(p.type||'')+' '+escapeHtml(p.value||'')+'</div>'; list.appendChild(d); }); }
  $('addPromo').addEventListener('click', ()=>{ DB.promos.push({id:'pr'+Date.now(), name:$('promo_name').value, type:$('promo_type').value, value:$('promo_val').value}); save(); redraw(); });
  redraw();
}));

// Payments manager
$('managePay').addEventListener('click', ()=> openEditor('Metody płatności', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<div id="payList"></div><div style="margin-top:8px"><input id="pay_name" placeholder="Nazwa"/><button id="addPay" class="ghost">Dodaj</button></div>';
  function redraw(){ const list = $('payList'); list.innerHTML=''; DB.payments.forEach(p=>{ const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f3f4f6'; d.innerHTML = '<strong>'+escapeHtml(p.name)+'</strong> <button data-id="'+p.id+'" class="ghost">Usuń</button>'; list.appendChild(d); }); list.querySelectorAll('[data-id]').forEach(b=> b.addEventListener('click', (e)=>{ DB.payments = DB.payments.filter(x=>x.id!==e.target.getAttribute('data-id')); save(); redraw(); populatePayments(); })); }
  $('addPay').addEventListener('click', ()=>{ DB.payments.push({id:'pay'+Date.now(), name:$('pay_name').value}); save(); redraw(); populatePayments(); });
  redraw();
}));

// Settings & login
$('btnSettings').addEventListener('click', ()=> openEditor('Ustawienia', ()=> {
  const body = $('editorBody');
  body.innerHTML = '<h4>Ustawienia lojalności</h4><div class="small">Ilość zł za 100 pkt:</div><input id="set_zl" value="'+loyalty.zlPer100+'"/><div class="small" style="margin-top:6px">Wartość 100 pkt w zł:</div><input id="set_val" value="'+loyalty.zlFor100pt+'"/><div style="margin-top:8px"><button id="saveSet" class="ghost">Zapisz</button></div>';
  $('saveSet').addEventListener('click', ()=>{ loyalty.zlPer100 = parseFloat($('set_zl').value) || 20; loyalty.zlFor100pt = parseFloat($('set_val').value) || 2.5; save(); alert('Zapisano'); });
}));

// Login handling
$('loginBtn').addEventListener('click', ()=> {
  const p = $('pwd').value;
  if(p==='1312'){ // success
    const node = $('loginModal'); node.parentNode.removeChild(node);
    initAfterLogin();
  } else {
    $('loginMsg').textContent = 'Błędne hasło';
  }
});
$('loginClose').addEventListener('click', ()=> { alert('Zaloguj się, aby używać aplikacji'); });

// initialize after login
function initAfterLogin(){
  $('userLabel').textContent = 'Maretti Admin';
  refreshCategories();
  renderProducts();
  populatePayments();
  renderCart();
  // fill loyalty config inputs
  $('cfg_zl_per_100').value = loyalty.zlPer100;
  $('cfg_100pt_to_zl').value = loyalty.zlFor100pt;
}

// till open/close
$('openTill').addEventListener('click', ()=> {
  const v = prompt('Kwota początkowa kasy (zł):','0');
  if(v===null) return;
  DB.till.open = true; DB.till.cash = parseFloat(v)||0;
  $('tillState').textContent = 'Otwarte: '+(DB.till.cash||0).toFixed(2)+' zł';
  $('openTill').classList.add('hidden'); $('closeTill').classList.remove('hidden');
  save();
});
$('closeTill').addEventListener('click', ()=> {
  const v = prompt('Kwota w kasie na koniec (zł):', DB.till.cash || 0);
  DB.till.open = false; DB.till.cash = parseFloat(v)||0;
  $('tillState').textContent = 'Zamknięta';
  $('openTill').classList.remove('hidden'); $('closeTill').classList.add('hidden');
  save();
});

// search & filter
$('search').addEventListener('input', (e)=> renderProducts(e.target.value));
$('filterCat').addEventListener('change', (e)=> {
  if(e.target.value === 'Wszystkie') renderProducts($('search').value);
  else renderProducts(e.target.value);
});
$('addManual').addEventListener('click', ()=> {
  const name = prompt('Nazwa produktu'); if(!name) return;
  const price = parseFloat(prompt('Cena'))||0;
  const p = {id:'p'+Date.now(), sku:'', name:name, price:price, stock:0, unit:'szt', category:'Ręczne'};
  DB.products.push(p); save(); renderProducts(); refreshCategories();
});

// loyalty save from sidebar
$('saveLoyal').addEventListener('click', ()=> {
  const a = parseFloat($('cfg_zl_per_100').value) || loyalty.zlPer100;
  const b = parseFloat($('cfg_100pt_to_zl').value) || loyalty.zlFor100pt;
  loyalty.zlPer100 = a; loyalty.zlFor100pt = b; save();
  alert('Zapisano ustawienia lojalności');
});

// Receipt PDF (simple printable page)
$('receipt').addEventListener('click', ()=> {
  const w = window.open('','_blank');
  const html = generateReceiptHtml(CART);
  w.document.write(html);
  w.document.close();
});

// utility: generate simple printable receipt
function generateReceiptHtml(cart){
  let out = '<html><head><meta charset="utf-8"><title>Paragon</title><style>body{font-family:Arial;padding:20px}h2{margin-top:0}</style></head><body>';
  out += '<h2>Paragon — POS Maretti</h2><table>';
  let total=0;
  cart.items.forEach(it=>{ out += '<tr><td>'+escapeHtml(it.name)+'</td><td>'+it.qty+' x '+it.price.toFixed(2)+'</td></tr>'; total += it.qty*it.price; });
  out += '</table><h3>Razem: '+total.toFixed(2)+' zł</h3><p>Data: '+new Date().toLocaleString()+'</p></body></html>';
  return out;
}

// helper escape
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

// initial auto-login check: keep login modal until correct
if(!document.getElementById('loginModal')) initAfterLogin();

// expose some globals for dev console
window._DB = DB; window._save = save; window._loyalty = loyalty;
</script>
</body>
</html>
